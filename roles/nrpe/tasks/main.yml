---
- name: Install the default set of packages NRPE needs
  yum:
    name: "{{ nrpe_packages }}"
    state: present
  vars:
    nrpe_packages:
      - nrpe
      - nagios-plugins-disk
      - nagios-plugins-users
      - nagios-plugins-swap
      - nagios-plugins-load
      - nagios-plugins-ping
      - nagios-plugins-procs
      - nagios-plugins-http
      - nagios-plugins-ntp
      - nagios-plugins-ssh
      - nagios-plugins-mysql
      - nagios-plugins-nrpe
      - python2

- name: Land NRPE default conf file
  template:
    src: nrpe.cfg.j2
    dest: /etc/nagios/nrpe.cfg
    owner: root
    group: root
    mode: 0644

- name: Land NRPE default plugins
  template:
    src: "default/{{ item }}.cfg.j2"
    dest: "/etc/nrpe.d/{{ item }}.cfg"
    owner: root
    group: root
    mode: 0644
  loop: "{{ nrpe_default_plugins }}"

- name: Land NRPE custom plugins
  template:
    src: "custom/{{ item }}.cfg.j2"
    dest: "/etc/nrpe.d/{{ item }}.cfg"
    owner: root
    group: root
    mode: 0644
  loop: "{{ nrpe_custom_plugins }}"
  notify: "Restart NRPE"
  when: nrpe_custom_plugins is defined and (nrpe_custom_plugins | type_debug == 'list')

- name: Start and enable NRPE
  service:
    name: nrpe
    state: started
    enabled: true
